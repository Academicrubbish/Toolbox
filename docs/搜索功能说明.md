# 首页模糊查询功能说明

## 功能概述

实现了首页记录的模糊查询功能，支持通过**时间**、**标题**、**总结内容**进行模糊查询。

## 云函数说明

### 云函数位置
`uniCloud-aliyun/cloudfunctions/searchRecord/index.js`

### 参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| keyword | String | 是 | 搜索关键词 |
| openid | String | 是 | 用户openid（用于权限控制） |
| pageNum | Number | 否 | 页码，默认1 |
| pageSize | Number | 否 | 每页数量，默认10 |
| searchType | String | 否 | 搜索类型，可选值：<br/>- `'all'`：全部（标题+时间+总结内容）<br/>- `'title'`：仅标题<br/>- `'time'`：仅时间<br/>- `'summary'`：仅总结内容<br/>默认 `'all'` |

### 返回格式

```javascript
{
  code: 0,           // 0表示成功，-1表示失败
  message: '查询成功',
  data: [],          // 记录列表（包含 summarizeContent 字段）
  total: 0           // 总记录数（用于分页）
}
```

## API 接口说明

### 接口位置
`api/record.js` 中的 `searchRecord` 函数

### 使用示例

```javascript
import { searchRecord } from '@/api/record.js'

// 全部搜索（标题+时间+总结内容）
searchRecord({
  keyword: '关键词',
  pageNum: 1,
  pageSize: 10,
  searchType: 'all'  // 可选：'all', 'title', 'time', 'summary'
}, { autoShowLogin: false })
  .then(res => {
    console.log('搜索结果：', res.result.data)
    console.log('总数：', res.result.total)
  })
  .catch(err => {
    console.error('搜索失败：', err)
  })
```

## 实现说明

### 1. 标题模糊查询
- 使用正则表达式进行模糊匹配
- 不区分大小写
- 支持部分匹配

### 2. 时间模糊查询
- 使用正则表达式匹配时间字符串
- 支持匹配时间格式中的任意部分（如：2024、2024-11、2024-11-21 等）

### 3. 总结内容模糊查询
- 先查询 `summarize` 表，找到 `content` 字段中包含关键词的记录
- 获取这些记录的 `recordId`（对应 `daily_record` 的 `_id`）
- 再查询 `daily_record` 表，使用 `_id in recordIds` 条件

### 4. 全部搜索（searchType='all'）
- 使用 `$or` 条件合并三种查询结果
- 标题匹配 OR 时间匹配 OR 总结内容匹配

## 注意事项

1. **权限控制**：所有查询都会自动过滤当前用户的记录（通过 `createBy: openid`）
2. **性能考虑**：总结内容查询需要两次数据库查询，如果数据量很大，建议使用索引优化
3. **分页支持**：返回结果包含 `total` 字段，可用于前端分页显示
4. **关联数据**：返回的记录会自动包含 `summarizeContent` 字段（如果存在）

## 如果只需要标题模糊查询

如果总结内容模糊查询实现复杂或性能不佳，可以只使用标题模糊查询：

```javascript
// 仅标题搜索
searchRecord({
  keyword: '关键词',
  pageNum: 1,
  pageSize: 10,
  searchType: 'title'
}, { autoShowLogin: false })
```

或者直接使用 JQL 查询（更简单）：

```javascript
// 在 api/record.js 中添加
export const searchRecordByTitle = function(data, options = {}) {
  return withAuth(function(data) {
    const { keyword, pageSize, pageNum } = data;
    const { skip, limit } = convertPagination(pageSize, pageNum);
    const user = store.state.user;
    const db = uniCloud.database();
    
    return getRequest()
      .where({
        createBy: user.openid,
        title: db.RegExp({
          regexp: keyword.trim(),
          options: 'i'
        })
      })
      .orderBy('createTime desc')
      .skip(skip)
      .limit(limit)
      .get();
  }, store, options)(data);
}
```

