# Markdown 渲染云函数部署说明

## 📦 已创建的文件

1. **云函数**：`uniCloud-aliyun/cloudfunctions/parseMarkdown/`
   - `index.js` - 云函数主文件
   - `package.json` - 依赖配置

2. **API 工具**：`api/markdown.js`
   - 前端调用云函数的封装函数

3. **已更新的前端文件**：
   - `component/md-editor/index.vue` - Markdown 编辑器
   - `subpackage/depart/detail.vue` - 记录详情页
   - `subpackage/knowledge/detail.vue` - 知识点详情页

## 🚀 部署步骤

### 1. 上传云函数依赖

在 HBuilderX 中：
1. 右键点击 `uniCloud-aliyun/cloudfunctions/parseMarkdown` 文件夹
2. 选择「上传云函数」
3. 等待上传完成（会自动安装依赖）

### 2. 验证云函数

在 HBuilderX 中：
1. 右键点击 `parseMarkdown` 云函数
2. 选择「运行云函数」
3. 测试参数：
```json
{
  "markdown": "# 测试标题\n\n这是一段**粗体**文本",
  "type": "markdown"
}
```

## 📝 使用说明

### 前端调用方式

```javascript
import { parseMarkdown } from "@/api/markdown";

// 解析 Markdown
const html = await parseMarkdown(markdownText, "markdown");

// 使用 towxml 渲染 HTML
this.towxmlData = this.towxml(html, "html", {
  events: {
    tap: (e) => {
      console.log("tap", e);
    },
  },
});
```

### 降级机制

如果云函数调用失败，代码会自动降级到本地解析：
- 使用 `this.towxml(markdown, "markdown")` 进行本地解析
- 确保在网络异常时仍能正常显示

## ⚙️ 云函数配置

### 依赖说明

云函数使用 `markdown-it` 库进行 Markdown 解析：
- 版本：^13.0.1
- 功能：支持标准 Markdown 语法

### 可选扩展

如果需要代码高亮，可以在云函数中添加：

```javascript
// 在 index.js 中
const hljs = require('highlight.js')
md.use(require('markdown-it-highlightjs'))
```

**注意**：添加代码高亮会增加云函数体积，需要更新 `package.json` 的 dependencies。

## 💡 优化效果

使用云函数后：
- **代码包减少**：约 500-800KB（移除了 towxml 的解析逻辑）
- **性能提升**：云函数解析速度更快
- **功能扩展**：可以轻松添加更多 Markdown 扩展功能

## ⚠️ 注意事项

1. **网络依赖**：需要网络连接才能使用云函数
2. **降级处理**：已实现自动降级，网络异常时使用本地解析
3. **首次加载**：云函数首次调用可能较慢（冷启动）
4. **成本考虑**：云函数调用会产生费用（通常很低）

## 🔧 故障排查

### 问题1：云函数调用失败

**检查项**：
- 云函数是否已上传
- 云函数依赖是否已安装
- 网络连接是否正常

**解决方案**：
- 重新上传云函数
- 检查云函数日志
- 代码会自动降级到本地解析

### 问题2：解析结果不正确

**检查项**：
- markdown-it 版本是否正确
- 传入的 markdown 文本格式是否正确

**解决方案**：
- 更新 markdown-it 到最新版本
- 检查 markdown 文本内容

## 📊 性能对比

| 方案 | 代码包大小 | 解析速度 | 网络依赖 |
|------|-----------|---------|---------|
| 本地解析 | 较大 | 中等 | 否 |
| 云函数解析 | 较小 | 快 | 是 |

